# ============================================================
#   íŒŒì¼ëª…: 09_keyword_trend_visualization.py
#   ê¸°ëŠ¥: ì‹œê¸°ë³„ ì£¼ìš” í‚¤ì›Œë“œ ë° ë³€í™”ìœ¨ ì‹œê°í™”
# ============================================================

import pandas as pd
import matplotlib.pyplot as plt
from collections import Counter
from konlpy.tag import Okt
import platform

# ================================
# âš™ï¸ í°íŠ¸ ì„¤ì • (macOS í•œê¸€ ê¹¨ì§ ë°©ì§€)
# ================================
if platform.system() == 'Darwin':  # macOS
    plt.rc('font', family='AppleGothic')
else:  # Windows / Linux ëŒ€ë¹„
    plt.rc('font', family='Malgun Gothic')

plt.rcParams['axes.unicode_minus'] = False  # ë§ˆì´ë„ˆìŠ¤ ê¹¨ì§ ë°©ì§€

# ğŸ”¹ í˜•íƒœì†Œ ë¶„ì„ê¸°
okt = Okt()

# ğŸ”¹ ë¶ˆìš©ì–´ ì„¤ì •
EXCLUDE_WORDS = [
    # ì •ì¹˜ ë° ê¸°ê´€ëª…
    'ì •ë¶€', 'ê³µì§ì', 'ê³µë¬´ì›', 'ì •ì±…', 'êµ­ê°€', 'ì œë„',
    'ìœ„ì›íšŒ', 'ë¶€ì²˜', 'êµ­íšŒ', 'ì¥ê´€', 'ëŒ€í†µë ¹', 'ì²­ì™€ëŒ€', 'ì„œìš¸ì‹œ',
    'ì˜ì›', 'ê¸°ì', 'ìœ„ì›', 'ìœ„ì›ì¥', 'ê´€ê³„ì', 'ë‹¨ì²´', 'ê¸°ê´€', 'ë³¸ë¶€',
    'ë°œí‘œ', 'íšŒì˜', 'ì˜ˆì‚°', 'ì¡°ì‚¬', 'ë³´ê³ ì„œ', 'ì–¸ë¡ ',

    # ì •ì¹˜ì¸ ë° ì •ë‹¹
    'ìœ¤ì„ì—´', 'ìœ¤ì„ë ¬', 'ê¹€ê±´í¬', 'ì´ì¬ëª…', 'ì¡°êµ­', 'ë¬¸ì¬ì¸', 'ë°•ê·¼í˜œ',
    'ì´ëª…ë°•', 'êµ­ë¯¼ì˜í˜', 'ë¯¼ì£¼ë‹¹', 'ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹', 'êµ­í˜', 'í˜ì‹ ë‹¹', 'ë¯¼ì£¼',
    'ì§„ë³´', 'ë³´ìˆ˜', 'ë”ë¶ˆì–´',

    # ì§€ëª… ë° ì§€ì—­
    'í•œêµ­', 'ëŒ€í•œë¯¼êµ­', 'ì„œìš¸', 'ì¼ë³¸', 'ëŒ€ë§Œ', 'ì§€ë°©', 'ê°•ì§„êµ°', 'ì „êµ­', 'ì¸ì²œ',

    # ë¶ˆí•„ìš” ì—°ê²°ì–´ / ê¸°ëŠ¥ì–´
    'ê´€ë ¨', 'í†µí•´', 'ì˜ê²¬', 'ë…¼ì˜', 'ì¶”ì§„', 'ë°©ì•ˆ', 'ì§€ì ',
    'í™•ëŒ€', 'ìš”êµ¬', 'ëŒ€ìƒ', 'ì¤‘ìš”', 'ì‚¬ì‹¤', 'ì…ì¥', 'ì‹œì‘', 'ì²˜ë¦¬',

    # ì‚¬ê±´Â·ì‚¬ê³  ë° ë‰´ìŠ¤ìš©ì–´
    'ì‚¬ê±´', 'ì‚¬ì•ˆ', 'í”¼í•´ì', 'ì„±í­ë ¥', 'ì„±í¬ë¡±', 'ë¹„ì„œ', 'ë¹„ì„œì‹¤',
    'íˆ¬í‘œ', 'ì„ ê±°', 'ëŒ€ì„ ', 'íƒ„í•µ', 'ì´›ë¶ˆ', 'ë²•ì•ˆ', 'ê²€ì°°', 'ì‹¬íŒ',

    # ì—­ì‚¬/ì˜ë¡€/êµ­ê°€ë³´í›ˆ
    'ì „ìŸ', 'í˜¸êµ­', 'í˜„ì¶©ì¼', 'ë…ë¦½ìš´ë™', 'ë…ë¦½ìš´ë™ê°€', 'íƒœê·¹ê¸°', 'ìœ ê³µ', 'ë³´í›ˆ', 'í¬ìƒ',

    # ì¼ë°˜ ì‚¬íšŒì–´
    'í•™êµ', 'í•™ìƒ', 'ì•„ì´', 'ìœ ì¹˜ì›', 'ë¶€ëª¨', 'ì¹œêµ¬', 'ê¸‰ì‹',
    'ì¶œì‚°ìœ¨', 'ê°€ì¡±', 'ë…¸ì¸', 'ì£¼íƒ', 'ì§€ì—­', 'ë¶€ë‹´',

    # ê¸°ì‚¬ ì‘ì„±ìš© í‘œí˜„
    'ëŒ€í‘œ', 'ê¸°íš', 'ê¸°ë¶„', 'ê²°ì •', 'ì‚¬ì‹¤', 'ì§€ë‚œë‹¬', 'ì‹œê°„', 'ë‚´ë…„', 'ì‚¬ì •', 'ì„ ì„', 'ë°œìƒ', 'ì‹ ê³ ',

    # ê¸°íƒ€ ë¶ˆí•„ìš” ë‹¨ì–´
    'íš¨ëŠ¥', 'ì—°êµ¬ì›', 'ì—°êµ¬ì†Œ', 'ì‚¬íšŒí•™', 'ë…ì', 'í‰ê°€', 'ëŒ€ì±…', 'ì•…ì„±'
]

# ğŸ”¹ ëª…ì‚¬ ì¶”ì¶œ í•¨ìˆ˜
def extract_nouns(text):
    words = okt.nouns(str(text))
    words = [w for w in words if len(w) > 1 and w not in EXCLUDE_WORDS]
    return words

# ğŸ”¹ CSV íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
def process_csv(file_path, output_name):
    df = pd.read_csv(file_path)
    text = ' '.join(df['clean_text'].astype(str))  # âœ… 'ë³¸ë¬¸' ëŒ€ì‹  'clean_text'
    words = extract_nouns(text)
    counter = Counter(words)
    result = pd.DataFrame(counter.most_common(50), columns=['ë‹¨ì–´', 'ë¹ˆë„'])
    result.to_csv(output_name, index=False, encoding='utf-8-sig')
    return result

# ğŸ”¹ íŒŒì¼ ê²½ë¡œ
file_2015_2019 = '../datas/clean_2015_2019.csv'
file_2020_2025 = '../datas/clean_2020_2025.csv'

# ğŸ”¹ ë°ì´í„° ì²˜ë¦¬
dedup_2015_2019 = process_csv(file_2015_2019, '../datas/dedup_2015_2019.csv')
dedup_2020_2025 = process_csv(file_2020_2025, '../datas/dedup_2020_2025.csv')

# ============================================================
#   (1) 2015â€“2019 ì£¼ìš” í‚¤ì›Œë“œ ìƒìœ„ 20 ì‹œê°í™”
# ============================================================
plt.figure(figsize=(10, 6))
plt.barh(dedup_2015_2019['ë‹¨ì–´'].head(20)[::-1], dedup_2015_2019['ë¹ˆë„'].head(20)[::-1])
plt.title('â‘  2015â€“2019 ì£¼ìš” í‚¤ì›Œë“œ ìƒìœ„ 20', fontsize=14)
plt.xlabel('ë¹ˆë„')
plt.ylabel('ë‹¨ì–´')
plt.tight_layout()
plt.savefig('../datas/keyword_top_2015_2019.png', dpi=300)
plt.show()

# ============================================================
#   (2) 2020â€“2025 ì£¼ìš” í‚¤ì›Œë“œ ìƒìœ„ 20 ì‹œê°í™”
# ============================================================
plt.figure(figsize=(10, 6))
plt.barh(dedup_2020_2025['ë‹¨ì–´'].head(20)[::-1], dedup_2020_2025['ë¹ˆë„'].head(20)[::-1])
plt.title('â‘¡ 2020â€“2025 ì£¼ìš” í‚¤ì›Œë“œ ìƒìœ„ 20', fontsize=14)
plt.xlabel('ë¹ˆë„')
plt.ylabel('ë‹¨ì–´')
plt.tight_layout()
plt.savefig('../datas/keyword_top_2020_2025.png', dpi=300)
plt.show()

# ============================================================
#   (3) ë‘ ì‹œê¸° ë¹„êµ ë³€í™”ìœ¨ ì‹œê°í™”
# ============================================================
trend_df = pd.merge(
    dedup_2015_2019, dedup_2020_2025, on='ë‹¨ì–´', how='outer', suffixes=('_15_19', '_20_25')
).fillna(0)

trend_df['ë³€í™”ìœ¨(%)'] = ((trend_df['ë¹ˆë„_20_25'] - trend_df['ë¹ˆë„_15_19']) / (trend_df['ë¹ˆë„_15_19'] + 1)) * 100
trend_df.to_csv('../datas/keyword_trend.csv', index=False, encoding='utf-8-sig')

top_change = trend_df.sort_values('ë³€í™”ìœ¨(%)', ascending=False).head(15)

plt.figure(figsize=(10, 6))
plt.barh(top_change['ë‹¨ì–´'], top_change['ë³€í™”ìœ¨(%)'])
plt.title('â‘¢ ê³µì§ ì¸ì‹ ì£¼ìš” í‚¤ì›Œë“œ ë³€í™” (2015â€“2019 â†’ 2020â€“2025)', fontsize=14)
plt.xlabel('ë¹ˆë„ ë³€í™”ìœ¨ (%)')
plt.ylabel('ë‹¨ì–´')
plt.gca().invert_yaxis()
plt.tight_layout()
plt.savefig('../datas/keyword_trend_change.png', dpi=300)
plt.show()
